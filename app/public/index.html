<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chatbot</title>
    <style>
      * {
        box-sizing: border-box;
      }

      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: #000000;
        color: #ffffff;
        margin: 0;
        padding: 20px;
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        gap: 1.5rem;
      }

      .container {
        width: 100%;
        max-width: 900px;
        margin: auto;
        display: flex;
        flex-direction: column;
        gap: 24px;
      }

      h1 {
        text-align: center;
        color: #007bff;
        font-size: 2.5rem;
        margin: 0 0 2rem 0;
        font-weight: 600;
      }

      #chat-box {
        height: 500px;
        background: #1a1a1a;
        border: 1px solid #333333;
        border-radius: 12px;
        overflow-y: auto;
        padding: 20px;
        width: 100%;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        scrollbar-width: thin;
        scrollbar-color: #007bff transparent;
      }

      #chat-box::-webkit-scrollbar {
        width: 6px;
      }

      #chat-box::-webkit-scrollbar-track {
        background: transparent;
      }

      #chat-box::-webkit-scrollbar-thumb {
        background: #007bff;
        border-radius: 3px;
      }

      .message {
        margin: 12px 0;
        padding: 16px 20px;
        border-radius: 12px;
        position: relative;
        animation: fadeIn 0.3s ease-in;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      }

      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }

      .user {
        background: #007bff8c;
        margin-left: 20px;
        border-bottom-right-radius: 4px;
        color: white;
      }

      .agent {
        background: #333333;
        margin-right: 20px;
        border-bottom-left-radius: 4px;
        color: white;
      }

      .tools {
        background: #1a1a1a;
        border: 1px solid #007bff;
        margin: 8px 40px;
        font-size: 0.9em;
        opacity: 0.9;
        color: #007bff;
      }

      .input-container {
        display: flex;
        gap: 12px;
        width: 100%;
        margin-top: 20px;
      }

      input {
        padding: 16px 24px;
        background: #1a1a1a;
        border: 2px solid #333333;
        border-radius: 25px;
        width: 100%;
        color: #ffffff;
        font-size: 16px;
        outline: none;
        transition: all 0.3s ease;
      }

      input:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
      }

      input::placeholder {
        color: #888888;
      }

      button {
        padding: 16px 24px;
        background: #007bff;
        border: none;
        border-radius: 25px;
        color: white;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
        min-width: 80px;
      }

      button:hover {
        background: #0056b3;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 123, 255, 0.4);
      }

      button:active {
        transform: translateY(0);
      }

      button:disabled {
        background: #555555;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      input:disabled {
        background: #0f0f0f;
        border-color: #222222;
        color: #666666;
        cursor: not-allowed;
      }

      /* Markdown content styling for dark mode */
      .message h1, .message h2, .message h3, .message h4, .message h5, .message h6 {
        margin: 15px 0 8px 0;
        color: #ffffff;
        font-weight: 600;
      }
      
      .message p {
        margin: 8px 0;
        line-height: 1.6;
        color: #ffffff;
      }
      
      .message code {
        background-color: #000000;
        color: #007bff;
        padding: 3px 6px;
        border-radius: 4px;
        font-family: 'JetBrains Mono', 'Fira Code', 'Courier New', monospace;
        font-size: 0.9em;
        border: 1px solid #333333;
      }
      
      .message pre {
        background-color: #000000;
        padding: 16px;
        border-radius: 8px;
        overflow-x: auto;
        margin: 12px 0;
        border: 1px solid #333333;
      }
      
      .message pre code {
        background: none;
        padding: 0;
        border: none;
        color: #ffffff;
      }
      
      .message ul, .message ol {
        margin: 8px 0;
        padding-left: 24px;
        color: #ffffff;
      }
      
      .message li {
        margin: 4px 0;
        line-height: 1.5;
      }
      
      .message blockquote {
        border-left: 4px solid #007bff;
        margin: 12px 0;
        padding: 12px 16px;
        color: #cccccc;
        background: #1a1a1a;
        border-radius: 0 4px 4px 0;
      }
      
      .message table {
        border-collapse: collapse;
        width: 100%;
        margin: 12px 0;
        background: #1a1a1a;
        border-radius: 8px;
        overflow: hidden;
      }
      
      .message th, .message td {
        border: 1px solid #333333;
        padding: 12px;
        text-align: left;
      }
      
      .message th {
        background: #000000;
        color: #007bff;
        font-weight: 600;
      }

      .message td {
        color: #ffffff;
      }

      .message a {
        color: #007bff;
        text-decoration: none;
        border-bottom: 1px solid transparent;
        transition: border-color 0.3s ease;
      }

      .message a:hover {
        border-bottom-color: #007bff;
      }

      .message strong {
        color: #ffffff;
        font-weight: 600;
      }
    </style>
  </head>
  <body>
    <!-- Include marked.js library for markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <div class="container">
      <h1>Alia Health</h1>
      <div id="chat-box"></div>
      <div class="input-container">
        <input
          type="text"
          id="message"
          placeholder="Type a message..."
          onkeypress="if(event.key==='Enter') sendMessage()"
        />
        <button onclick="sendMessage()" id="sendbtn">Send</button>
      </div>
    </div>

    <script>
      let conversationId = "";

      async function sendMessage() {
        const message = document.getElementById("message").value;
        if (!message) return;
        
        // Disable send button during processing
        const sendBtn = document.getElementById("sendbtn");
        const messageInput = document.getElementById("message");
        sendBtn.disabled = true;
        sendBtn.textContent = "Sending...";
        messageInput.disabled = true;
        
        // Render user message with markdown
        const userMessageDiv = document.createElement('div');
        userMessageDiv.className = 'message user';
        userMessageDiv.innerHTML = `<strong>User:</strong> ${marked.parse(message)}`;
        document.getElementById("chat-box").appendChild(userMessageDiv);

        // Prepare JSON request body
        const requestBody = {
          prompt: message
        };
        
        if (conversationId) {
          requestBody.conversation_id = conversationId;
        }

        try {
          const response = await fetch("http://localhost:8000/chat", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(requestBody),
          });

          // Check if the response is ok
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          messageInput.value = "";

          const reader = response.body.getReader();
          const decoder = new TextDecoder();
          let chunk;
          let currentAgentMessage = "";
          let agentMessageDiv = null;

          try {
            while (!(chunk = await reader.read()).done) {
              const lines = decoder
                .decode(chunk.value)
                .split("\n")
                .filter((line) => line.trim());
              
              lines.forEach((line) => {
                if (line.startsWith("data: ")) {
                  try {
                    const jsonData = line.substring(6); // Remove "data: " prefix
                    const data = JSON.parse(jsonData);
                    
                    // Extract conversation_id from response if not set
                    if (data.conversation_id && !conversationId) {
                      conversationId = data.conversation_id;
                    }
                    
                    // Handle the streaming response structure
                    if (data.choices && data.choices[0] && data.choices[0].delta) {
                      const delta = data.choices[0].delta;
                      const content = delta.content || "";
                      const tool = delta.tool || "";
                      
                      if (tool) {
                        // Handle different agent types
                        if (tool === "main_agent") {
                          // Main agent response - show as regular agent message
                          if (!agentMessageDiv) {
                            agentMessageDiv = document.createElement('div');
                            agentMessageDiv.className = 'message agent';
                            agentMessageDiv.innerHTML = '<strong>Agent:</strong> ';
                            document.getElementById("chat-box").appendChild(agentMessageDiv);
                            currentAgentMessage = "";
                          }
                          
                          currentAgentMessage += content;
                          agentMessageDiv.innerHTML = `<strong>Agent:</strong> ${marked.parse(currentAgentMessage)}`;
                          
                        } else if (tool === "transcript_agent") {
                          // Transcript agent response - show with special indicator
                          if (!agentMessageDiv) {
                            agentMessageDiv = document.createElement('div');
                            agentMessageDiv.className = 'message agent';
                            agentMessageDiv.innerHTML = '<strong>📄 Transcript Analysis:</strong> ';
                            document.getElementById("chat-box").appendChild(agentMessageDiv);
                            currentAgentMessage = "";
                          }
                          
                          currentAgentMessage += content;
                          agentMessageDiv.innerHTML = `<strong>📄 Transcript Analysis:</strong> ${marked.parse(currentAgentMessage)}`;
                          
                        } else if (tool === "error") {
                          const toolDiv = document.createElement('div');
                          toolDiv.className = 'message tools';
                          toolDiv.style.borderColor = '#dc3545';
                          toolDiv.style.color = '#dc3545';
                          toolDiv.innerHTML = `<strong>❌ Error:</strong> ${marked.parse(content)}`;
                          document.getElementById("chat-box").appendChild(toolDiv);
                        } else if (content) {
                          // Generic tool message
                          const toolDiv = document.createElement('div');
                          toolDiv.className = 'message tools';
                          toolDiv.innerHTML = `<strong>🔧 ${tool}:</strong> ${marked.parse(content)}`;
                          document.getElementById("chat-box").appendChild(toolDiv);
                        }
                      } else if (content) {
                        // Handle agent messages - append to current message
                        if (!agentMessageDiv) {
                          agentMessageDiv = document.createElement('div');
                          agentMessageDiv.className = 'message agent';
                          agentMessageDiv.innerHTML = '<strong>Agent:</strong> ';
                          document.getElementById("chat-box").appendChild(agentMessageDiv);
                          currentAgentMessage = "";
                        }
                        
                        currentAgentMessage += content;
                        // Parse markdown for agent messages
                        agentMessageDiv.innerHTML = `<strong>Agent:</strong> ${marked.parse(currentAgentMessage)}`;
                      }
                      
                      // Check for finish_reason to end the current message
                      if (data.choices[0].finish_reason === "stop") {
                        agentMessageDiv = null;
                        currentAgentMessage = "";
                      }
                    }
                  } catch (e) {
                    console.error("Error parsing JSON:", e);
                  }
                }
              });
              
              // Auto-scroll to bottom
              const chatBox = document.getElementById("chat-box");
              chatBox.scrollTop = chatBox.scrollHeight;
            }
          } catch (streamError) {
            console.error("Error during streaming:", streamError);
            
            // Display error message to user
            const errorDiv = document.createElement('div');
            errorDiv.className = 'message tools';
            errorDiv.style.borderColor = '#dc3545';
            errorDiv.style.color = '#dc3545';
            errorDiv.innerHTML = `<strong>❌ Streaming Error:</strong> ${streamError.message}`;
            document.getElementById("chat-box").appendChild(errorDiv);
            
            // Auto-scroll to bottom
            const chatBox = document.getElementById("chat-box");
            chatBox.scrollTop = chatBox.scrollHeight;
          }

        } catch (error) {
          console.error("Error during request:", error);
          
          // Display error message to user
          const errorDiv = document.createElement('div');
          errorDiv.className = 'message tools';
          errorDiv.style.borderColor = '#dc3545';
          errorDiv.style.color = '#dc3545';
          errorDiv.innerHTML = `<strong>❌ Connection Error:</strong> ${error.message}`;
          document.getElementById("chat-box").appendChild(errorDiv);
          
          // Auto-scroll to bottom
          const chatBox = document.getElementById("chat-box");
          chatBox.scrollTop = chatBox.scrollHeight;
        } finally {
          // Re-enable controls
          sendBtn.disabled = false;
          sendBtn.textContent = "Send";
          messageInput.disabled = false;
          messageInput.focus();
        }
      }
    </script>
  </body>
</html>
